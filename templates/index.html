<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Realtime Speech-to-Text (No Duplicates)</title>

<style>
  body      { font-family: Arial, sans-serif; text-align: center; margin-top: 3rem; }
  #record   { padding: 0.6rem 2rem; font-size: 1rem; }
  #status   { margin-top: 1rem; color: #888; }
  #output   { margin: 2rem auto; max-width: 720px; font-size: 1.35rem; line-height: 1.6; white-space: pre-wrap; }
  .interim  { color: #999; }
</style>
</head>

<body>
  <h1>üéôÔ∏è Browser Speech-to-Text</h1>
  <button id="record">Start</button>
  <p id="status">Idle</p>
  <div id="output"></div>

<script>
/* -------- 1. Feature detection -------- */
window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!window.SpeechRecognition){
  alert("Web Speech API is not supported in this browser.\nTry Chrome, Edge or any Chromium-based browser.");
}

/* -------- 2. Init recognizer -------- */
const rec = new SpeechRecognition();
rec.lang           = "ur-PK";   // change to e.g. "en-US", "ar-SA", ‚Ä¶ if you like
rec.continuous     = true;      // keep mic open
rec.interimResults = true;      // show grey live words

/* -------- 3. DOM refs -------- */
const btn    = document.getElementById("record");
const status = document.getElementById("status");
const output = document.getElementById("output");

let listening = false;
let fullText  = "";   // everything we‚Äôve already committed

/* -------- 4. Button handler -------- */
btn.onclick = () => listening ? rec.stop() : rec.start();

/* -------- 5. Visual state -------- */
rec.onstart = () => { listening = true;  btn.textContent="Stop";  status.textContent="Listening‚Ä¶"; };
rec.onend   = () => { listening = false; btn.textContent="Start"; status.textContent="Idle"; };

/* -------- 6. MAIN LOGIC: append only the delta -------- */
rec.onresult = (e) => {
  let interim      = "";
  let latestFinal  = "";

  /* collect interim + final for this event */
  for (let i = e.resultIndex; i < e.results.length; ++i){
    const txt = e.results[i][0].transcript;
    (e.results[i].isFinal ? latestFinal : interim) += txt;
  }

  /* ---- delta trick ----
     Chrome often re-sends the entire sentence as it grows:
       f1: "ŸÖ€å⁄∫"
       f2: "ŸÖ€å⁄∫ ÿ™ŸÖ"
       f3: "ŸÖ€å⁄∫ ÿ™ŸÖ ÿ≥€í"
     So we remove the prefix we already stored (if present)    */
  if (latestFinal){
     if (latestFinal.startsWith(fullText)){
         latestFinal = latestFinal.slice(fullText.length);
     }
     fullText += latestFinal + " ";   // commit ONLY the new words
  }

  /* render */
  output.innerHTML = fullText + '<span class="interim">' + interim + '</span>';
};

/* -------- 7. Optional clean-up when user stops -------- */
rec.addEventListener("end", () => {
   /* collapse accidental word-word stutter */
   fullText = fullText.replace(/\b(\S+)( \1\b)+/g, '$1');
   output.textContent = fullText.trim();
});
</script>
</body>
</html>
